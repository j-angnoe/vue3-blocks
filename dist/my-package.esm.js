import{defineAsyncComponent,createApp as createApp$1}from"vue";import"vue-router";function createDeferred(){const e={};return e.promise=new Promise(((t,r)=>{e.resolve=t,e.reject=r})),e}function fetchXhr(e,t){return(t=t||{}).headers=t.headers||{},t.headers["X-Requested-With"]="XMLHttpRequest",fetch(e,t)}function tryEvaluateProperty(node,propertyName,defaultValue=null){if(node.hasAttribute(propertyName)){let propValue=node.getAttribute(propertyName).trim();if(propValue.startsWith("{")||propValue.startsWith("["))try{return eval("("+propValue+")")}catch(e){throw new Error("Error parsing property "+propertyName+" of "+node.outerHTML.split(/\n/,2)[0]+": "+e)}else if(propValue>"")return propValue.trim().split(/\s*,\s*/)}return defaultValue}class EmbeddedScript{constructor(e){this.scriptEl=e}splitScriptIntoParts(){const e=this.scriptEl.innerHTML.split("\n").map((e=>[e.trimLeft().startsWith("import "),e]));let t={};const r=e.filter((e=>e[0])).map((e=>e[1])).map((e=>{const[r,o]=e.match(/["']([^'"]+)["']\s*;?\s*/);if(o.endsWith(".vue"))return t[o.split("/").pop().split(".vue")[0]]=defineAsyncComponent((async()=>{const{ExternalComponent:e}=await Promise.resolve().then((function(){return ExternalComponent$1}));return new e(document.createElement("template"),o).GetVueDefinition()})),null;try{return import.meta.resolve(o),e}catch(t){return console.log("esming "+o),e.replace(r,`"https://esm.sh/${o}"`)}})).filter(Boolean).join("\n");return[r,e.filter((e=>!e[0])).map((e=>e[1])).join("\n"),t]}converClassDefinitionToVueOptionsDefinition(e){let t=e?new e:{},{props:r,watch:o,computed:n,components:s,directives:a,...i}=t;const c=["beforeCreate","created","beforeMount","mounted","beforeUpdate","updated","activated","deactivated","beforeUnmount","unmounted","errorCaptured","renderTracked","renderTriggered","destroyed","beforeDestroy"];let l={},p={};for(var u of Object.getOwnPropertyNames(e.prototype))"constructor"!=u&&"function"==typeof e.prototype[u]&&(~c.indexOf(u)?p[u]=e.prototype[u]:l[u]=e.prototype[u],delete i[u]);return{data:()=>JSON.parse(JSON.stringify(i)),props:r,watch:o,computed:n,components:s,directives:a,...p,filters:i.filters||{},methods:l}}async EvaluateComponentDefinition(){let deferred=createDeferred(),[preamble,code,components]=this.splitScriptIntoParts(),receivePayload;if(this.scriptEl.hasAttribute("setup")){preamble.includes("vue")||(preamble=`import { ref, nextTick, reactive, provide, inject, computed, watch, onMounted, onUnmounted } from "vue";\n${preamble}`);let props=null,propName="$props",emits=null,emitName="$emit";if(code.trim()>""){const acorn=await import("https://esm.sh/acorn"),referenceCode="function program(){"+code+"\n}",ast=acorn.parse(referenceCode,{ecmaVersion:"latest",sourceType:"module"});console.log(ast);let returnValues=[],getVariableNames=e=>{switch(e.id.type){case"Identifier":return[e.id.name];case"ObjectPattern":return e.id.properties.map((e=>e.value.name))}},replaces={};for(const node of ast.body[0].body.body)switch(console.log("node",node),node.type){case"VariableDeclaration":node.declarations.forEach((node=>{returnValues.push(...getVariableNames(node));let callee=node.init?.callee?.name;switch(callee){case"defineProps":props=eval(referenceCode.substring(node.init.callee.end,node.init.end)),propName="$setupFunctionProps",replaces[referenceCode.substring(node.init.start,node.init.end)]="$setupFunctionProps";break;case"defineEmits":emits=eval(referenceCode.substring(node.init.callee.end,node.init.end)),replaces[referenceCode.substring(node.init.start,node.init.end)]="$setupFunctionEmits",emitName="$setupFunctionEmits"}}));break;case"FunctionDeclaration":returnValues.push(...getVariableNames(node));break;case"ReturnStatement":returnValues=[]}Object.entries(replaces).forEach((([e,t])=>{code=code.replace(e,t)})),returnValues.length&&(console.log("return values will be "+returnValues.join(",")),code+="\nreturn {"+returnValues.join(",")+"}\n"),console.log(code)}receivePayload=e=>deferred.resolve({components:components,props:props,emits:emits,setup:e}),code=`function(${propName}, { emit: ${emitName} }) { ${code} \n}`,console.log(code)}else{let e=this.converClassDefinitionToVueOptionsDefinition;code.match("return class vue")?code=code.replace(/return\s+class\s+vue\s*\{/,"return class {"):code.match("export default")?(code=code.replace("export default","return "),e=e=>e):code=code.replace(/return\s+class\s+\{/,"return class {"),code=code.replace(/\sconstructor\s*\(/,"mounted("),code=code.replace(/\sdestructor\s*\(/,"destroyed("),code=`(function() { ${code} \n })()`,receivePayload=function(t){let r=e(t);r.components??={},r.components={...components,...r.components},deferred.resolve(r)}}const scriptId=Math.random().toString(36).substring(2,10),newScript=document.createElement("script");return newScript.type="module",newScript.id=scriptId,newScript.innerHTML=`${preamble}\n\n        document.getElementById("${scriptId}").dispatchEvent(new CustomEvent("payload", {detail: ${code}})\n)`,newScript.addEventListener("payload",(e=>{receivePayload(e.detail)})),document.body.appendChild(newScript),await deferred.promise}}class EmbeddedStyle{constructor(e,t){if(!e)throw new Error("styleEl is invalid");if(!t)throw new Error("templateEl is invalid");this.styleEl=e,this.templateEl=t}Activate(){let e=document.createElement("style"),t=this.styleEl.innerHTML.trim();if(t){if(this.styleEl.hasAttribute("scoped")){let e="css-"+Math.random().toString(36).substring(2,10);for(let t of this.templateEl.content.children)t.setAttribute(e,"");t=t.replace(/([^\}]+?)\{/g,((e,t)=>e.match(/^\s*@/)?e:t.split(",").map((e=>`&${e}`.replace(/&&/g,"&"))).join(",")+"{")),t=t.replace(/:(scope|root)/,"&"),t=`*[${e}] { ${t} }`}e.innerHTML=t,document.head.append(e)}}}class EmbeddedComponent{constructor(e,t){this.el=e,this.name=t}RegisterWith(e){e.component(this.GetName(),this.GetVueDefinition())}GetName(){return this.name}async GetClonedTemplate(){return this.el.cloneNode(!0)}FinalizeEvaluatedComponent(e,t){const r=tryEvaluateProperty(this.el,"props"),o=tryEvaluateProperty(this.el,"emits"),n={template:t,...e};return r&&(n.props??=r),o&&(n.emits??=o),n}GetVueDefinition(){let e=createDeferred();return(async()=>{let t=await this.GetClonedTemplate(),r="";const o=t.content.querySelector('script:not([src]):not([type^="text"])');if(o){let t=new EmbeddedScript(o);o.parentNode.removeChild(o),t.EvaluateComponentDefinition().then((t=>{const o=this.FinalizeEvaluatedComponent(t,r);console.log("finalized Component",o),e.resolve(o)}))}else window.setTimeout((()=>{e.resolve({template:r})}));var n=t.content.querySelectorAll("style"),s=t.content.querySelectorAll(":not(style,script)");1==s.length&&s[0].matches("template")&&(t=s[0]);for(let e of n)new EmbeddedStyle(e,t).Activate(),e.parentNode.removeChild(e);r=t.innerHTML})(),defineAsyncComponent((()=>e.promise))}}class EmbeddedPage extends EmbeddedComponent{constructor(e,t){super(e,EmbeddedPage.GetComponentName(t)),this.url=t}static GetComponentName(e){return"page-"+(e.replace(/^\//,"").replace(/[^a-z0-9-]/g,"-")||"index")}FinalizeEvaluatedComponent(e,t){let r=super.FinalizeEvaluatedComponent(e,t);return this.url.match(/\/:/)&&(r.props??=[],this.url.replace(/\/:([a-z0-9_]+)/i,(function(e,t){Array.isArray(r.props)?r.props.push(t):"object"==typeof r.props?r.props[t]??=String:console.error("failed to add route prop to props",r)}))),console.log("finalcomponent",r),r}CreateRoute(){let e={path:this.url,name:this.name,props:!0,meta:{title:this.el.getAttribute("title")},component:this.GetVueDefinition()};return this.el.hasAttribute("redirect")&&(e.redirect=this.el.getAttribute("redirect")),e}RegisterWith(e){e.routes??=[],e.routes.push(this.CreateRoute())}}class EmbeddedSubPage extends EmbeddedPage{RegisterWith(e){console.log("Register subpage "+this.url+" with name "+this.name,e),e.routes??=[];let t={path:""};for(let r of e.routes)console.log("checking parent "+r.path),0===this.url.indexOf(r.path)&&(t=r.path>t.path?r:t);if(!t)throw new Error("sub-url could not find parent for url `"+this.url+"`");const r=this.url.substr(t.path.length+1);let o=this.CreateRoute();o.name=this.name.replace(/^page-/,"subpage-")+(r>""?"":"index"),t.children??=[],t.children.push(o),console.log("Attaching "+this.url+" to "+t.name+" "+t.path)}}class ExternalComponent extends EmbeddedComponent{constructor(e,t){super(e,t.split("/").pop().split(".").shift()),this.src=t}async GetClonedTemplate(){let e=document.createElement("template");var t=await fetchXhr(this.src).then((e=>e.text()));return e.innerHTML=t,e}}var ExternalComponent$1=Object.freeze({__proto__:null,ExternalComponent:ExternalComponent});class VueBlocks{static urlsLoaded={};static async collectComponents(e){e=e||document.body;const t={"template[component]":e=>new EmbeddedComponent(e,e.getAttribute("component")),'template[src*=".vue"]':e=>{const t=e.getAttribute("src");if(!(t in VueBlocks.urlsLoaded))return VueBlocks.urlsLoaded[t]=!0,new ExternalComponent(e,t)},"template[url]":e=>new EmbeddedPage(e,e.getAttribute("url")),"template[sub-url]":e=>new EmbeddedSubPage(e,e.getAttribute("sub-url")),'template[src]:not([src*=".vue"])':async e=>{const t=new URL(e.getAttribute("src"),window.location.href);if(t.href in VueBlocks.urlsLoaded)return;VueBlocks.urlsLoaded[t.href]=!0;var r=await fetchXhr(t.href).then((e=>e.text()));let o=document.createElement("template");return o.innerHTML=r,[...o.content.querySelectorAll("link")].forEach((e=>{e.href=new URL(e.getAttribute("href"),t.href).href,document.body.appendChild(e)})),[...o.content.querySelectorAll("script[src]")].forEach((e=>{e.src=new URL(e.getAttribute("src"),t.href).href,document.body.appendChild(e)})),[...o.content.querySelectorAll("script")].forEach((e=>{e.innerHTML=e.innerHTML.replace(/document\.location/g,"(new URL("+JSON.stringify(t.href)+"))")})),await VueBlocks.collectComponents(o.content)}},r=Object.entries(t).map((([t,r])=>Promise.all([...e.querySelectorAll(t)].map(r))));var o=await Promise.all(r),n=[];for(const e of o)n=e instanceof Promise?n.concat(await e):n.concat(e);return console.log("reasult",n),n.flat().filter(Boolean)}static async load(e,t){var r=await VueBlocks.collectComponents(t);for(const t of r)t.RegisterWith(e);return r}static async mount(e,t){if(t=t||createApp$1({setup(){}}),await VueBlocks.load(t),t.routes){const{createRouter:e,createWebHashHistory:r}=await import("vue-router"),o=e({history:r(),routes:t.routes});t.provide("routes",t.routes),t.config.globalProperties.routes=t.routes,t.use(o)}const r=document.querySelector(e);return""==r.innerHTML.trim()&&(r.innerHTML="<app></app>"),t.mount(r),t}}function createApp(e){const t=createApp$1(e);return t.use(VueBlocks),t}export{createApp};
